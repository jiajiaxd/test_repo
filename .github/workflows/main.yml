name: Smart Release Workflow

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Semver version (éœ€è¦é…åˆchangelog/level/significance)'
        required: false
      changelog:
        description: 'ç‰ˆæœ¬æ›´æ–°æ—¥å¿—'
        required: false
      level:
        description: 'ä¸¥é‡ç­‰çº§ (critical/important/normal)'
        required: false
      significance:
        description: 'å˜æ›´ç­‰çº§ (major/minor/patch)'
        required: false
      broadcast:
        description: 'å¹¿æ’­æ¶ˆæ¯å†…å®¹'
        required: false

jobs:
  input_validation:
    name: ğŸ›‚ è¾“å…¥éªŒè¯ & æ¨¡å¼åˆ¤æ–­
    runs-on: ubuntu-latest
    outputs:
      mode: ${{ steps.mode_detection.outputs.mode }}
      need_build: ${{ steps.mode_detection.outputs.need_build }}
    steps:
      - name: æ¨¡å¼æ£€æµ‹
        id: mode_detection
        run: |
          # æ¨¡å¼åˆ¤æ–­é€»è¾‘
          if [ -n "${{ inputs.version }}" ]; then
            [ -z "${{ inputs.changelog }}" ] && echo "âŒ ç‰ˆæœ¬å‘å¸ƒéœ€è¦changelogå‚æ•°" && exit 1
            [ -z "${{ inputs.level }}" ] && echo "âŒ ç‰ˆæœ¬å‘å¸ƒéœ€è¦levelå‚æ•°" && exit 1
            [ -z "${{ inputs.significance }}" ] && echo "âŒ ç‰ˆæœ¬å‘å¸ƒéœ€è¦significanceå‚æ•°" && exit 1
            
            if [ -n "${{ inputs.broadcast }}" ]; then
              echo "mode=both" >> $GITHUB_OUTPUT
              echo "need_build=true" >> $GITHUB_OUTPUT
            else
              echo "mode=version" >> $GITHUB_OUTPUT
              echo "need_build=true" >> $GITHUB_OUTPUT
            fi
          elif [ -n "${{ inputs.broadcast }}" ]; then
            echo "mode=broadcast" >> $GITHUB_OUTPUT
            echo "need_build=false" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ— æ•ˆçš„è¾“å…¥å‚æ•°ï¼šå¿…é¡»æä¾›ç‰ˆæœ¬ä¿¡æ¯æˆ–å¹¿æ’­æ¶ˆæ¯" >&2
            exit 1
          fi

  file_modification:
    name: ğŸ“ æ–‡ä»¶ä¿®æ”¹
    needs: input_validation
    runs-on: ubuntu-latest
    outputs:
      commit_message: ${{ steps.generate_commit.outputs.msg }}
    steps:
      - uses: actions/checkout@v4
      
      - name: æ‰§è¡Œæ–‡ä»¶ä¿®æ”¹
        run: |
          python .github/scripts/modify_files.py \
            ${INPUT_VERSION:+--version "$INPUT_VERSION"} \
            ${INPUT_CHANGELOG:+--changelog "$INPUT_CHANGELOG"} \
            ${INPUT_LEVEL:+--level "$INPUT_LEVEL"} \
            ${INPUT_SIGNIFICANCE:+--significance "$INPUT_SIGNIFICANCE"} \
            ${INPUT_BROADCAST:+--broadcast "$INPUT_BROADCAST"}
        env:
          INPUT_VERSION: ${{ inputs.version }}
          INPUT_CHANGELOG: ${{ inputs.changelog }}
          INPUT_LEVEL: ${{ inputs.level }}
          INPUT_SIGNIFICANCE: ${{ inputs.significance }}
          INPUT_BROADCAST: ${{ inputs.broadcast }}

      - name: ç”Ÿæˆæäº¤ä¿¡æ¯
        id: generate_commit
        run: |
          msg_parts=()
          if [ -n "${{ inputs.version }}" ]; then
            msg_parts+=("Release ${{ inputs.version }}: ${{ inputs.changelog }}")
          fi
          if [ -n "${{ inputs.broadcast }}" ]; then
            msg_parts+=("Broadcast update: ${{ inputs.broadcast }}")
          fi
          echo "msg=${msg_parts[*]}" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v3
        with:
          name: modified-files
          path: |
            utils/static.py
            public.json

  build_and_release:
    name: ğŸ—ï¸ æ„å»º & å‘å¸ƒ
    needs: [input_validation, file_modification]
    if: ${{ needs.input_validation.outputs.need_build == 'true' }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]
    
    steps:
      - uses: actions/download-artifact@v3
        with:
          name: modified-files
          path: .

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
        run: |
          pip install pyinstaller
          pip install -r requirements.txt
          python utils/add_build_info.py
          pyinstaller -F Steamauto.py \
            --collect-all apprise \
            --name Steamauto-${{ matrix.os }} \
            --add-data "plugins:plugins"

      - uses: actions/upload-artifact@v3
        with:
          name: build-${{ matrix.os }}
          path: dist/

  finalization:
    name: ğŸš€ æœ€ç»ˆå‘å¸ƒ
    needs: 
      - input_validation
      - file_modification
      - build_and_release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ä¸‹è½½ä¿®æ”¹åçš„æ–‡ä»¶
        uses: actions/download-artifact@v3
        with:
          name: modified-files
          path: .

      - name: æ›´æ–°ä¸‹è½½ä¿¡æ¯
        if: ${{ needs.input_validation.outputs.need_build == 'true' }}
        run: |
          python .github/scripts/update_downloads.py \
            --version "${{ inputs.version }}" \
            --repo ${{ github.repository }}

      - name: æäº¤æ›´æ”¹
        uses: EndBug/add-and-commit@v9
        with:
          add: utils/static.py public.json
          message: "${{ needs.file_modification.outputs.commit_message }}"
          author_name: "GitHub Actions"
          author_email: "actions@github.com"

      - name: åˆ›å»ºRelease
        if: ${{ needs.input_validation.outputs.need_build == 'true' }}
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ inputs.version }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: releases/*
          body: |
            ## ç‰ˆæœ¬æ›´æ–° ${{ inputs.version }}
            **å˜æ›´ç±»å‹**: ${{ inputs.significance }}
            **ä¸¥é‡ç­‰çº§**: ${{ inputs.level }}
            ### æ›´æ–°æ—¥å¿—
            ${{ inputs.changelog }}